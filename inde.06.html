<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="./logo.png">
    <title>B-Baria Telecom - বি-বাড়িয়া টেলিকম</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Hind Siliguri for Bangla) -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Hind Siliguri"', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                            600: '#475569'
                        },
                        accent: {
                            DEFAULT: '#3b82f6',
                            hover: '#2563eb'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a; 
            color: #e2e8f0; 
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        .hidden-section {
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Drag and Drop Styles */
        .draggable-item {
            cursor: move;
            transition: all 0.2s ease;
        }
        .draggable-item.dragging {
            opacity: 0.5;
            background: #334155 !important;
            border: 2px dashed #3b82f6;
            transform: scale(0.98);
        }
        /* Custom Checkbox Style */
        .custom-checkbox input:checked + div {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-50 glass-panel border-b border-gray-700 shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showSection('customer')">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                    <i class="fa-solid fa-mobile-screen-button"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-wide text-white">B - <span class="text-blue-500">Baria</span></h1>
            </div>

            <div class="flex gap-6 text-sm md:text-base font-medium">
                <button id="nav-customer" onclick="showSection('customer')" class="hover:text-blue-400 transition py-1 nav-active">
                    <i class="fa-solid fa-store mr-1"></i> কাস্টমার ভিউ
                </button>
                <button id="nav-admin" onclick="checkAdminAccess()" class="hover:text-blue-400 transition py-1">
                    <i class="fa-solid fa-user-shield mr-1"></i> এডমিন ভিউ
                </button>
                <button id="nav-orders" onclick="showSection('orders')" class="hidden hover:text-blue-400 transition py-1">
                    <i class="fa-solid fa-list-check mr-1"></i> অর্ডার লিস্ট
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto px-4 py-6">

        <div id="toast" class="fixed top-20 right-5 z-50 hidden p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 border border-gray-600"></div>

        <div id="firebase-status" class="fixed bottom-5 left-5 z-40 bg-dark-800 px-3 py-2 rounded-lg border border-gray-700 text-xs text-gray-400 flex flex-col gap-1 hidden shadow-lg">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-gray-500" id="master-indicator"></div>
                <span id="master-text">Master: Off</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-gray-500" id="active-indicator"></div>
                <span id="active-text">Active: Local</span>
            </div>
        </div>

        <!-- SECTION: Customer View -->
        <section id="section-customer" class="fade-in">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-white mb-2">আমাদের সার্ভিসসমূহ</h2>
                <p class="text-gray-400">আপনার প্রয়োজনীয় সেবাটি বেছে নিন এবং অর্ডার করুন</p>
            </div>

            <div class="max-w-xl mx-auto mb-8 relative">
                <input type="text" id="customer-search" oninput="renderCustomerView()" placeholder="সার্ভিস খুঁজুন..." class="w-full bg-dark-800 border border-gray-600 rounded-full py-3 px-5 focus:outline-none focus:border-blue-500 text-white placeholder-gray-500">
                <i class="fa-solid fa-search absolute right-5 top-4 text-gray-500"></i>
            </div>

            <div id="customer-services-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <div class="col-span-full text-center text-gray-500 py-10">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-3 text-blue-500"></i>
                    <p>ডাটা লোড হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...</p>
                 </div>
            </div>
        </section>

        <!-- SECTION: Admin Login Modal -->
        <div id="modal-login" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm">
            <div class="glass-panel p-8 rounded-xl w-full max-w-md mx-4 shadow-2xl transform transition-all scale-100">
                <div class="text-center mb-6">
                    <i class="fa-solid fa-lock text-4xl text-blue-500 mb-3"></i>
                    <h3 class="text-2xl font-bold text-white">এডমিন লগইন</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">পাসওয়ার্ড</label>
                        <input type="password" id="admin-password" class="w-full bg-dark-900 border border-gray-600 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none" placeholder="পাসওয়ার্ড দিন">
                    </div>
                    <button onclick="performLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        লগইন করুন
                    </button>
                    <button onclick="closeModal('modal-login')" class="w-full text-gray-400 hover:text-white py-2 text-sm">
                        বাতিল করুন
                    </button>
                </div>
            </div>
        </div>

        <!-- SECTION: Admin Dashboard & Management -->
        <section id="section-admin" class="hidden-section fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white border-l-4 border-blue-500 pl-3">এডমিন ড্যাশবোর্ড</h2>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-medium">
                    <i class="fa-solid fa-sign-out-alt"></i> লগআউট
                </button>
            </div>

            <!-- Stats Cards Container (Dynamic Rendering) -->
            <div id="admin-stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">
                <!-- Cards will be injected here via JS -->
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-700 mb-6">
                <button class="px-4 py-2 text-blue-400 border-b-2 border-blue-400 font-medium">ম্যানেজ সার্ভিস</button>
                <button onclick="document.getElementById('db-settings').classList.toggle('hidden')" class="px-4 py-2 text-gray-400 hover:text-white">টিম ও ডাটাবেজ</button>
            </div>

            <!-- DB Settings (UPDATED) -->
            <div id="db-settings" class="hidden bg-dark-800 p-4 rounded-lg mb-6 border border-gray-700 animate-fade-in">
                
                <!-- STEP 1: Hardcoded Master DB Info -->
                <div class="mb-4 p-3 bg-purple-900/30 border border-purple-700 rounded-lg text-xs text-purple-300">
                    <i class="fa-solid fa-server mr-2"></i> মাস্টার ডাটাবেজ অটোমেটিক কানেক্টেড (বিল্ট-ইন)।
                </div>

                <!-- STEP 2: Share Own Config -->
                <div class="mb-6 border-b border-gray-700 pb-6">
                    <h3 class="font-bold text-lg mb-2 text-blue-400">১. ডাটাবেজ শেয়ার ও এডিট</h3>
                    <p class="text-xs text-gray-400 mb-3">নতুন ডাটাবেজ যুক্ত করুন অথবা তালিকা থেকে এডিট বাটনে ক্লিক করে তথ্য আপডেট করুন।</p>
                    
                    <input type="hidden" id="share-doc-id"> <!-- Hidden ID field for updates -->
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                        <input type="text" id="share-name" placeholder="আপনার নাম (উদাঃ মিজান)" class="input-field">
                        <input type="email" id="share-email" placeholder="আপনার ইমেইল" class="input-field">
                    </div>
                    <textarea id="share-config" placeholder='আপনার Firebase Config JSON...' class="bg-dark-900 border border-gray-600 rounded p-2 text-sm text-white w-full h-16 font-mono text-xs mb-2"></textarea>
                    
                    <div class="flex gap-2">
                        <button onclick="shareMyConfig()" id="btn-share-config" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 w-full">শেয়ার করুন</button>
                        <button onclick="resetShareForm()" id="btn-reset-share" class="bg-gray-600 text-white px-4 py-2 rounded text-sm hover:bg-gray-700 hidden">বাতিল</button>
                    </div>
                </div>

                <!-- STEP 3: Active Database Selection -->
                <div>
                    <h3 class="font-bold text-lg mb-2 text-green-400">২. অ্যাক্টিভ ডাটাবেজ নির্বাচন করুন</h3>
                    <p class="text-xs text-gray-400 mb-3">যেকোনো একটি কনফিগারেশন সিলেক্ট করুন। <br><span class="text-yellow-400">টিপস:</span> ড্রাগ করে পছন্দের ডাটাবেজটিকে সবার উপরে রাখুন, তাহলে কাস্টমাররা সেটিই দেখতে পাবে।</p>
                    
                    <div class="bg-dark-900 rounded-lg p-2 max-h-60 overflow-y-auto" id="team-config-list">
                        <div class="text-center text-gray-500 py-4 text-xs"><i class="fa-solid fa-spinner fa-spin"></i> মাস্টার ডাটাবেজ লোড হচ্ছে...</div>
                    </div>
                </div>

            </div>

            <!-- Manage Services Area -->
            <div class="glass-panel rounded-xl p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-xl font-bold">সার্ভিস ও প্রোডাক্ট তালিকা</h3>
                    <div class="flex gap-2 w-full md:w-auto">
                         <div class="relative w-full">
                            <input type="text" id="admin-search" oninput="renderAdminItems()" placeholder="সার্চ করুন..." class="w-full bg-dark-900 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none text-white">
                        </div>
                        <button onclick="openItemModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg whitespace-nowrap shadow-lg">
                            <i class="fa-solid fa-plus"></i> নতুন যুক্ত করুন
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-gray-400 border-b border-gray-700 text-sm">
                                <th class="p-3">নাম</th>
                                <th class="p-3">ক্যাটাগরি</th>
                                <th class="p-3">কেনা দাম</th>
                                <th class="p-3">বিক্রয় মূল্য</th>
                                <th class="p-3">স্টক</th>
                                <th class="p-3 text-center">বিক্রয় (কুইক)</th>
                                <th class="p-3 text-right">অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody id="admin-items-body" class="text-gray-300 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- Transaction History Section -->
            <div class="glass-panel rounded-xl p-6 border-l-4 border-purple-500 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-white"><i class="fa-solid fa-clock-rotate-left mr-2"></i> লেনদেনের ইতিহাস (History)</h3>
                        <p class="text-xs text-gray-400 mt-1">প্রতিটি কাজের পরিমাণ, খরচ এবং লাভের বিস্তারিত হিসাব</p>
                    </div>
                    <button onclick="resetHistory()" class="text-red-400 border border-red-500 px-3 py-1 rounded hover:bg-red-500 hover:text-white transition text-xs flex items-center gap-1">
                        <i class="fa-solid fa-trash-can"></i> রিসেট
                    </button>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto bg-dark-900 rounded-lg border border-gray-700">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-dark-800 z-10 shadow-md">
                            <tr class="text-gray-400 border-b border-gray-700 text-xs uppercase">
                                <th class="p-3"><i class="fa-regular fa-calendar mr-1"></i> তারিখ</th>
                                <th class="p-3">কাজের বিবরণ</th>
                                <th class="p-3 text-center">পরিমাণ</th>
                                <th class="p-3 text-right">খরচ (Cost)</th>
                                <th class="p-3 text-right">বিক্রয় (Sale)</th>
                                <th class="p-3 text-right">লাভ (Profit)</th>
                            </tr>
                        </thead>
                        <tbody id="history-body" class="text-gray-300 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- DANGER ZONE (Updated for Granular Reset) -->
            <div class="glass-panel rounded-xl p-6 border border-red-900/50 bg-red-900/10">
                <h3 class="text-xl font-bold text-red-400 mb-2"><i class="fa-solid fa-triangle-exclamation mr-2"></i> ডেঞ্জার জোন (Danger Zone)</h3>
                <p class="text-gray-400 text-sm mb-4">সতর্কতা: এখান থেকে আপনি ডাটাবেজের তথ্য মুছে ফেলতে পারেন। বুঝে শুনে ক্লিক করুন।</p>
                <div class="flex flex-col md:flex-row gap-4">
                    <button onclick="openHardResetModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 transition hover:scale-105">
                        <i class="fa-solid fa-skull-crossbones"></i> কাস্টম রিসেট (Custom Reset)
                    </button>
                    <p class="text-xs text-gray-500 self-center">এই বাটনে ক্লিক করে আপনি বেছে নিতে পারবেন কোন ডাটাগুলো (হিস্ট্রি, অ্যাকাউন্ট, সার্ভিস) আপনি ডিলিট করতে চান।</p>
                </div>
            </div>
        </section>

        <!-- SECTION: Orders List -->
        <section id="section-orders" class="hidden-section fade-in">
            <h2 class="text-2xl font-bold text-white mb-6 border-l-4 border-yellow-500 pl-3">অর্ডার তালিকা</h2>
            <div id="orders-container" class="space-y-4">
                <div class="text-center text-gray-500 mt-10">কোনো অর্ডার পেন্ডিং নেই</div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-dark-800 border-t border-gray-700 py-8 mt-auto">
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
            <div>
                <h3 class="text-xl font-bold text-white mb-2">B - Baria Telecom</h3>
                <p class="text-gray-400 text-sm">আপনার বিশ্বস্ত ডিজিটাল সেবা এবং গ্যাজেট শপ।</p>
            </div>
            <div>
                <h4 class="text-white font-semibold mb-3">যোগাযোগ</h4>
                <p class="text-gray-400 text-sm mb-1"><i class="fa-solid fa-phone mr-2"></i> +880 1703-582125</p>
                <p class="text-gray-400 text-sm"><i class="fa-solid fa-envelope mr-2"></i> NokshaLab@gmail.com</p>
            </div>
            <div>
                <h4 class="text-white font-semibold mb-3">সোশ্যাল মিডিয়া</h4>
                <div class="flex justify-center md:justify-start gap-4">
                    <a href="https://web.facebook.com/NokshaLab/" class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center text-white hover:bg-blue-500"><i class="fa-brands fa-facebook-f"></i></a>
                    <a href="https://api.whatsapp.com/send?phone=8801703582125" class="w-8 h-8 rounded bg-green-500 flex items-center justify-center text-white hover:bg-green-400"><i class="fa-brands fa-whatsapp"></i></a>
                    <a href="https://www.youtube.com/@NokshaLab" class="w-8 h-8 rounded bg-red-600 flex items-center justify-center text-white hover:bg-red-500"><i class="fa-brands fa-youtube"></i></a>
                </div>
            </div>
        </div>
        <div class="text-center text-gray-600 text-xs mt-8 pt-4 border-t border-gray-700">
            &copy; 2024 Noksha Lab. All rights reserved.
        </div>
    </footer>

    <!-- MODALS -->
    
    <!-- Manage Cash Modal (UPDATED with Reset Button) -->
    <div id="modal-manage-cash" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4">
            <h3 class="text-lg font-bold text-white mb-4">ক্যাশ ম্যানেজমেন্ট</h3>
            <label class="text-xs text-gray-400 block mb-1">টাকার পরিমাণ</label>
            <input type="number" id="manage-cash-amount" placeholder="0" class="input-field mb-3">
            <label class="text-xs text-gray-400 block mb-1">বিবরণ / কারণ (ঐচ্ছিক)</label>
            <input type="text" id="manage-cash-desc" placeholder="যেমন: ব্যক্তিগত খরচ, বাসা থেকে আনা..." class="input-field mb-4">
            <div class="flex gap-3 mb-3">
                <button onclick="submitCashTransaction('add')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold transition"><i class="fa-solid fa-plus"></i> জমা</button>
                <button onclick="submitCashTransaction('withdraw')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold transition"><i class="fa-solid fa-minus"></i> উত্তোলন</button>
            </div>
            <button onclick="resetCash()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded font-bold transition mb-3"><i class="fa-solid fa-arrows-rotate"></i> রিসেট (০ করুন)</button>
            <button onclick="closeModal('modal-manage-cash')" class="w-full text-gray-400 text-sm hover:text-white">বন্ধ করুন</button>
        </div>
    </div>

    <!-- Manage Accounts Modal -->
    <div id="modal-manage-accounts" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-white">অ্যাকাউন্ট তালিকা</h3>
                    <p class="text-gray-400 text-sm">আপনার সকল অনলাইন ও ব্যাংকিং অ্যাকাউন্ট ম্যানেজ করুন</p>
                </div>
                <button onclick="openAccountFormModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fa-solid fa-plus mr-1"></i> নতুন যুক্ত করুন</button>
            </div>
            <div class="overflow-x-auto bg-dark-900 rounded-lg border border-gray-700 mb-6">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700 text-xs uppercase bg-dark-800">
                            <th class="p-3">অ্যাকাউন্টের নাম</th>
                            <th class="p-3 text-right">বর্তমান ব্যালেন্স</th>
                            <th class="p-3 text-center">লেনদেন</th>
                            <th class="p-3 text-right">অ্যাকশন</th>
                        </tr>
                    </thead>
                    <tbody id="accounts-list-body" class="text-gray-300 text-sm"></tbody>
                    <tfoot class="border-t border-gray-700 bg-dark-800">
                        <tr><td class="p-3 font-bold text-white">মোট ব্যালেন্স</td><td class="p-3 text-right font-bold text-blue-400" id="modal-total-balance">৳ 0</td><td colspan="2"></td></tr>
                    </tfoot>
                </table>
            </div>
            <button onclick="closeModal('modal-manage-accounts')" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded">বন্ধ করুন</button>
        </div>
    </div>

    <!-- Account Form Modal -->
    <div id="modal-account-form" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 border border-blue-500/30">
            <h3 class="text-lg font-bold text-white mb-4" id="account-form-title">নতুন অ্যাকাউন্ট</h3>
            <input type="hidden" id="account-id">
            <label class="text-xs text-gray-400 block mb-1">অ্যাকাউন্টের নাম</label>
            <input type="text" id="account-name" placeholder="যেমন: বিকাশ এজেন্ট, রকেট পার্সোনাল" class="input-field mb-4">
            <div id="initial-balance-div">
                <label class="text-xs text-gray-400 block mb-1">শুরুর ব্যালেন্স</label>
                <input type="number" id="account-initial-balance" placeholder="0" class="input-field mb-4">
            </div>
            <div class="flex gap-3">
                <button onclick="saveAccount()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">সেভ করুন</button>
                <button onclick="closeModal('modal-account-form')" class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700">বাতিল</button>
            </div>
        </div>
    </div>

    <!-- Account Transaction Modal -->
    <div id="modal-account-transact" class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 border border-green-500/30">
            <h3 class="text-lg font-bold text-white mb-2" id="transact-account-name">লেনদেন করুন</h3>
            <p class="text-xs text-gray-400 mb-4">এই অ্যাকাউন্টে টাকা জমা বা উত্তোলন করুন</p>
            <input type="hidden" id="transact-account-id">
            <label class="text-xs text-gray-400 block mb-1">টাকার পরিমাণ</label>
            <input type="number" id="transact-amount" placeholder="0" class="input-field mb-3">
            <label class="text-xs text-gray-400 block mb-1">বিবরণ (ঐচ্ছিক)</label>
            <input type="text" id="transact-desc" placeholder="যেমন: লোড নেওয়া হলো" class="input-field mb-4">
            <div class="flex gap-3">
                <button onclick="submitAccountTransaction('deposit')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold transition flex justify-center items-center gap-1"><i class="fa-solid fa-plus"></i> জমা</button>
                <button onclick="submitAccountTransaction('withdraw')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold transition flex justify-center items-center gap-1"><i class="fa-solid fa-minus"></i> খরচ/নেওয়া</button>
            </div>
            <button onclick="closeModal('modal-account-transact')" class="w-full mt-3 text-gray-500 text-sm hover:text-white">বন্ধ করুন</button>
        </div>
    </div>

    <!-- Quick Sale Modal (UPDATED) -->
    <div id="modal-quicksale" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4">
            <h3 class="text-lg font-bold text-white mb-4">কাজের পরিমাণ ও দাম নির্ধারণ</h3>
            <div class="bg-dark-900 p-3 rounded mb-4 border border-gray-700">
                <p id="qs-name" class="text-blue-400 font-bold mb-1"></p>
                <div class="flex justify-between text-xs text-gray-400">
                    <span>ফিক্সড প্রাইস: <span id="qs-price" class="text-white"></span></span>
                    <span>কেনা দাম: <span id="qs-cost" class="text-white"></span></span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">পরিমাণ (Qty)</label>
                    <input type="number" id="qs-qty" value="1" min="1" class="input-field text-center font-bold" oninput="updateQSPreview()">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">বিক্রয় মূল্য (একক)</label>
                    <input type="number" id="qs-custom-price" class="input-field text-center font-bold border-blue-500" oninput="updateQSPreview()">
                </div>
            </div>

            <div class="mb-4 text-center">
                <p class="text-xs text-gray-400">মোট বিল হবে:</p>
                <p class="text-xl font-bold text-green-400">৳ <span id="qs-total">0</span></p>
                <p class="text-[10px] text-gray-500 mt-1">সম্ভাব্য লাভ: ৳ <span id="qs-profit-preview">0</span></p>
            </div>
            <div class="flex gap-3">
                <button onclick="submitQuickSale()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">কনফার্ম</button>
                <button onclick="closeModal('modal-quicksale')" class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700">বাতিল</button>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="modal-product-details" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-md mx-4 transform transition-all scale-100">
            <h3 class="text-2xl font-bold text-white mb-2" id="pd-name">Product Name</h3>
            <span id="pd-category" class="bg-blue-900 text-blue-300 text-xs px-2 py-1 rounded uppercase font-bold mb-4 inline-block">CATEGORY</span>
            
            <!-- Content Container -->
            <div id="pd-content" class="space-y-4"></div>

            <button onclick="closeModal('modal-product-details')" class="w-full mt-6 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold">বন্ধ করুন</button>
        </div>
    </div>

    <!-- Customer Order Modal -->
    <div id="modal-order" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-4">অর্ডার কনফার্ম করুন</h3>
            <div class="mb-4 bg-dark-900 p-3 rounded border border-gray-700">
                <p class="text-blue-400 font-bold" id="order-item-name">Item Name</p>
                <p class="text-gray-400 text-sm mt-1">দাম: <span id="order-item-price" class="text-white"></span> টাকা</p>
            </div>
            <input type="text" id="order-customer-name" placeholder="আপনার নাম" class="w-full bg-dark-800 border border-gray-600 rounded p-2 mb-3 text-white">
            <input type="tel" id="order-customer-phone" placeholder="ফোন নাম্বার" class="w-full bg-dark-800 border border-gray-600 rounded p-2 mb-4 text-white">
            <div class="flex gap-3">
                <button onclick="submitOrder()" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">অর্ডার করুন</button>
                <button onclick="closeModal('modal-order')" class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700">বন্ধ করুন</button>
            </div>
        </div>
    </div>

    <!-- Hard Reset Modal (NEW) -->
    <div id="modal-hard-reset" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 border-2 border-red-900/50 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-800">
                    <i class="fa-solid fa-trash-can text-3xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white">কি কি ডিলিট করতে চান?</h3>
                <p class="text-xs text-gray-400 mt-2">সতর্কতা: নিচের সিলেক্ট করা আইটেমগুলো চিরতরে মুছে যাবে।</p>
            </div>
            
            <div class="space-y-3 mb-6 bg-dark-900 p-4 rounded-lg border border-gray-700">
                <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">
                    <input type="checkbox" id="reset-history" class="hidden">
                    <div class="w-5 h-5 border-2 border-gray-600 rounded flex items-center justify-center transition-colors">
                        <svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span class="text-gray-300 text-sm">লেনদেনের ইতিহাস (History)</span>
                </label>
                
                <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">
                    <input type="checkbox" id="reset-accounts" class="hidden">
                    <div class="w-5 h-5 border-2 border-gray-600 rounded flex items-center justify-center transition-colors">
                        <svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span class="text-gray-300 text-sm">অ্যাকাউন্ট তালিকা (Accounts)</span>
                </label>
                
                <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">
                    <input type="checkbox" id="reset-items" class="hidden">
                    <div class="w-5 h-5 border-2 border-gray-600 rounded flex items-center justify-center transition-colors">
                        <svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span class="text-gray-300 text-sm">সার্ভিস ও প্রোডাক্ট তালিকা</span>
                </label>

                <label class="flex items-center space-x-3 cursor-pointer custom-checkbox">
                    <input type="checkbox" id="reset-orders" class="hidden">
                    <div class="w-5 h-5 border-2 border-gray-600 rounded flex items-center justify-center transition-colors">
                        <svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <span class="text-gray-300 text-sm">অর্ডার তালিকা (Orders)</span>
                </label>
            </div>

            <div class="flex gap-3">
                <button onclick="submitHardReset()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold transition shadow-lg">মুছে ফেলুন</button>
                <button onclick="closeModal('modal-hard-reset')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded transition">বাতিল</button>
            </div>
        </div>
    </div>

    <!-- Admin Add/Edit Item Modal -->
    <div id="modal-item" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm overflow-y-auto">
        <div class="glass-panel p-6 rounded-xl w-full max-w-lg mx-4 my-10">
            <h3 class="text-xl font-bold text-white mb-4" id="modal-item-title">নতুন কাজ/প্রোডাক্ট যুক্ত করুন</h3>
            <input type="hidden" id="item-id">
            <div class="grid grid-cols-1 gap-3">
                <input type="text" id="item-name" placeholder="কাজের/প্রোডাক্টের নাম" class="input-field">
                <input type="text" id="item-category" placeholder="ক্যাটাগরি (উদাঃ পাসপোর্ট, রিচার্জ)" class="input-field">
                <textarea id="item-docs" placeholder="প্রয়োজনীয় কাগজপত্র (কমা দিয়ে লিখুন)" class="input-field h-20"></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs text-gray-400">কেনা দাম (Cost)</label><input type="number" id="item-cost" placeholder="0" class="input-field"></div>
                    <div><label class="text-xs text-gray-400">বিক্রয় মূল্য (Price)</label><input type="number" id="item-price" placeholder="0" class="input-field"></div>
                </div>
                <div><label class="text-xs text-gray-400">স্টক পরিমাণ</label><input type="number" id="item-stock" placeholder="Unlimited হলে -1 দিন" class="input-field"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveItem()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">সেভ করুন</button>
                <button onclick="closeModal('modal-item')" class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700">বাতিল</button>
            </div>
        </div>
    </div>

    <!-- CSS Helper Classes for Inputs -->
    <style>
        .input-field {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
            font-size: 0.875rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA STRUCTURE & STATE ---
        const initialData = {
            cash: 0,
            balance: 0,
            stockVal: 0,
            profit: 0,
            items: [], 
            orders: [],
            history: [],
            accounts: [],
            cardOrder: ['capital', 'cash', 'balance', 'stock', 'profit'] 
        };

        let appData = initialData;
        let localDbList = []; 
        
        let masterDB = null;
        let activeDB = null;
        let activeDBUnsubscribe = null;
        
        // --- HARDCODED MASTER CONFIG ---
        const MASTER_CONFIG = {
            apiKey: "AIzaSyC6mBOhj1HGCy0wtbPEI0SLs99NsKOo6kI",
            authDomain: "nokshalab-nokshalab.firebaseapp.com",
            projectId: "nokshalab-nokshalab",
            storageBucket: "nokshalab-nokshalab.firebasestorage.app",
            messagingSenderId: "1023619403590",
            appId: "1:1023619403590:web:971cab0bc3bee397f91f47"
        };

        let isAdminLoggedIn = localStorage.getItem('isAdminLoggedIn') === 'true';
        const savedActiveConfig = localStorage.getItem('activeConfig');

        // Stats Card Definitions (Updated with Actions)
        const statsDefinitions = {
            'capital': { icon: 'fa-coins', color: 'teal', title: 'মোট মূলধন', valueKey: 'capital', sub: 'ক্যাশ + ব্যালেন্স + স্টক', action: '' },
            'cash': { icon: 'fa-wallet', color: 'green', title: 'ক্যাশ টাকা', valueKey: 'cash', sub: 'জমা বা উত্তোলন করতে ক্লিক করুন', action: 'openManageCashModal()' },
            'balance': { icon: 'fa-building-columns', color: 'blue', title: 'অ্যাকাউন্ট ব্যালেন্স', valueKey: 'balance', sub: 'বিকাশ, রকেট, ইত্যাদির হিসাব', action: 'openAccountsModal()' },
            'stock': { icon: 'fa-boxes-stacked', color: 'orange', title: 'স্টক এমাউন্ট', valueKey: 'stockVal', sub: 'মোট স্টকের কেনা দাম', action: '' },
            'profit': { icon: 'fa-chart-line', color: 'purple', title: 'মোট লাভ', valueKey: 'profit', sub: 'রিসেট করতে ক্লিক করুন', action: 'confirmResetProfit()' }
        };

        // --- AUTHENTICATION ---
        const ADMIN_PASS = "M~R.88@Mizhan.25";

        function checkAdminAccess() {
            if (isAdminLoggedIn) {
                showSection('admin');
            } else {
                document.getElementById('modal-login').classList.remove('hidden');
            }
        }

        function performLogin() {
            const pass = document.getElementById('admin-password').value;
            if (pass === ADMIN_PASS) {
                isAdminLoggedIn = true;
                localStorage.setItem('isAdminLoggedIn', 'true');
                closeModal('modal-login');
                showToast("লগইন সফল হয়েছে!", "success");
                showSection('admin');
                renderNav();
            } else {
                showToast("ভুল পাসওয়ার্ড!", "error");
            }
        }

        function logout() {
            isAdminLoggedIn = false;
            localStorage.setItem('isAdminLoggedIn', 'false');
            showSection('customer');
            renderNav();
            showToast("লগআউট সফল!", "neutral");
        }

        // --- FIREBASE LOGIC ---
        function initMasterApp(config) {
            try {
                let app;
                const existingApp = firebase.apps.find(a => a.name === 'masterApp');
                if (existingApp) {
                    app = existingApp;
                } else {
                    app = firebase.initializeApp(config, 'masterApp');
                }
                
                masterDB = app.firestore();
                document.getElementById('master-indicator').classList.remove('bg-gray-500');
                document.getElementById('master-indicator').classList.add('bg-green-500', 'animate-pulse');
                document.getElementById('master-text').innerText = "Master: Connected";
                document.getElementById('firebase-status').classList.remove('hidden');
                
                fetchTeamConfigs();

            } catch (err) {
                console.error("Master Init Error", err);
                showToast("মাস্টার কানেকশন ফেইল্ড", "error");
            }
        }

        function fetchTeamConfigs() {
            if(!masterDB) return;
            const listDiv = document.getElementById('team-config-list');
            listDiv.innerHTML = '<div class="text-center text-gray-500 py-2"><i class="fa-solid fa-spinner fa-spin"></i> লোড হচ্ছে...</div>';

            masterDB.collection('shared_configs').onSnapshot(snapshot => {
                localDbList = []; 
                if(snapshot.empty) {
                    listDiv.innerHTML = '<div class="text-center text-gray-500 text-xs">কোনো শেয়ার্ড ডাটাবেজ নেই।</div>';
                    renderCustomerView(); 
                    return;
                }

                snapshot.forEach(doc => {
                    localDbList.push({ id: doc.id, ...doc.data() });
                });

                const savedOrder = JSON.parse(localStorage.getItem('dbListOrder') || '[]');
                if (savedOrder.length > 0) {
                    localDbList.sort((a, b) => {
                        const idxA = savedOrder.indexOf(a.id);
                        const idxB = savedOrder.indexOf(b.id);
                        if (idxA === -1 && idxB === -1) return 0;
                        if (idxA === -1) return 1;
                        if (idxB === -1) return -1;
                        return idxA - idxB;
                    });
                }

                renderDbList(); 

                if (!activeDB && !localStorage.getItem('activeConfig') && localDbList.length > 0) {
                    const firstConfig = localDbList[0];
                    if (firstConfig && firstConfig.config) {
                        console.log("Auto-connecting to priority database:", firstConfig.name);
                        initActiveApp(firstConfig.config);
                        showToast(`অটো-কানেক্ট: ${firstConfig.name}`, "neutral");
                    }
                } else if (!activeDB && !localStorage.getItem('activeConfig')) {
                     renderCustomerView();
                }

            }, error => {
                console.error("Master DB Access Error:", error);
                listDiv.innerHTML = `<div class="text-center text-red-400 py-2 text-xs">Access Denied! Check Rules.</div>`;
                renderCustomerView(); 
            });
        }

        function renderDbList() {
            const listDiv = document.getElementById('team-config-list');
            listDiv.innerHTML = '';
            
            localDbList.forEach((data, index) => {
                let activeStyle = "border-gray-700 bg-dark-800";
                if (savedActiveConfig && data.config && JSON.parse(savedActiveConfig).projectId === data.config.projectId) {
                    activeStyle = "border-green-500 bg-green-900/20";
                }
                
                const configString = JSON.stringify(data.config).replace(/"/g, '&quot;');
                const cleanConfig = JSON.stringify(data.config).replace(/"/g, '&quot;');
                const safeName = data.name ? data.name.replace(/'/g, "\\'") : '';
                const safeEmail = data.email ? data.email.replace(/'/g, "\\'") : '';

                const item = `
                    <div class="draggable-item border ${activeStyle} rounded p-3 mb-2 flex flex-col md:flex-row justify-between items-start md:items-center gap-3 hover:bg-dark-700"
                         draggable="true" data-type="db" data-index="${index}">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-grip-lines text-gray-600 cursor-grab"></i>
                            <div>
                                <h4 class="font-bold text-white text-sm">${data.name}</h4>
                                <p class="text-xs text-gray-400">${data.email}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="activateDatabase(${configString})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs flex-1 md:flex-none text-center">
                                ব্যবহার করুন
                            </button>
                            <button onclick="editSharedConfig('${data.id}', '${safeName}', '${safeEmail}', '${cleanConfig}')" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="deleteSharedConfig('${data.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                listDiv.innerHTML += item;
            });
            addDragListeners();
        }

        // --- SHARED CONFIG CRUD ---
        function shareMyConfig() {
            if(!masterDB) { showToast("মাস্টার ডাটাবেজ কানেক্টেড নয়!", "error"); return; }
            const docId = document.getElementById('share-doc-id').value;
            const name = document.getElementById('share-name').value;
            const email = document.getElementById('share-email').value;
            const configStr = document.getElementById('share-config').value;
            if(!name || !email || !configStr) { showToast("সব তথ্য পূরণ করুন", "error"); return; }
            let config;
            try { try { config = JSON.parse(configStr); } catch(e) { config = new Function("return " + configStr)(); } }
            catch(e) { showToast("ভুল কনফিগারেশন কোড", "error"); return; }
            const payload = { name, email, config, timestamp: new Date() };
            const action = docId ? masterDB.collection('shared_configs').doc(docId).update(payload) : masterDB.collection('shared_configs').add(payload);
            action.then(() => { showToast(docId ? "আপডেট সফল হয়েছে!" : "কনফিগারেশন শেয়ার সফল হয়েছে!", "success"); resetShareForm(); })
            .catch(err => { console.error(err); showToast("অ্যাকশন ব্যর্থ হয়েছে (Rules চেক করুন)", "error"); });
        }

        function editSharedConfig(id, name, email, configStr) {
            document.getElementById('share-doc-id').value = id;
            document.getElementById('share-name').value = name;
            document.getElementById('share-email').value = email;
            try { const obj = JSON.parse(configStr); document.getElementById('share-config').value = JSON.stringify(obj, null, 2); } 
            catch(e) { document.getElementById('share-config').value = configStr; }
            document.getElementById('btn-share-config').innerText = "আপডেট করুন";
            document.getElementById('btn-reset-share').classList.remove('hidden');
            document.getElementById('share-name').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteSharedConfig(id) {
            if(!masterDB) return;
            if(confirm("আপনি কি নিশ্চিত এই কনফিগারেশনটি ডিলিট করতে চান?")) {
                masterDB.collection('shared_configs').doc(id).delete().then(() => showToast("কনফিগারেশন ডিলিট হয়েছে", "neutral")).catch(err => showToast("ডিলিট ব্যর্থ হয়েছে", "error"));
            }
        }

        function resetShareForm() {
            document.getElementById('share-doc-id').value = '';
            document.getElementById('share-name').value = '';
            document.getElementById('share-email').value = '';
            document.getElementById('share-config').value = '';
            document.getElementById('btn-share-config').innerText = "শেয়ার করুন";
            document.getElementById('btn-reset-share').classList.add('hidden');
        }

        function activateDatabase(config) {
            localStorage.setItem('activeConfig', JSON.stringify(config));
            initActiveApp(config);
            showToast("ডাটাবেজ এক্টিভেট হয়েছে!", "success");
        }

        function initActiveApp(config) {
            try {
                if (firebase.apps.length > 0) {
                    const defaultApp = firebase.apps.find(a => a.name === '[DEFAULT]');
                    if(defaultApp) { defaultApp.delete().then(() => doInitActive(config)); } else { doInitActive(config); }
                } else { doInitActive(config); }
            } catch(e) { console.error(e); }
        }

        function doInitActive(config) {
            const app = firebase.initializeApp(config);
            activeDB = app.firestore();
            document.getElementById('active-indicator').classList.remove('bg-gray-500');
            document.getElementById('active-indicator').classList.add('bg-green-500', 'animate-pulse');
            document.getElementById('active-text').innerText = "Active: " + config.projectId;
            document.getElementById('firebase-status').classList.remove('hidden');
            const docRef = activeDB.collection('noksha_store').doc('main_data');
            activeDBUnsubscribe = docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    appData = doc.data();
                    if(!appData.accounts) appData.accounts = [];
                    if(!appData.items) appData.items = [];
                    if(!appData.orders) appData.orders = []; // Ensure orders array exists
                    // Ensure cardOrder is robustly initialized
                    if(!appData.cardOrder || !Array.isArray(appData.cardOrder)) {
                        appData.cardOrder = initialData.cardOrder;
                    } else if (!appData.cardOrder.includes('capital')) {
                        appData.cardOrder.unshift('capital');
                    }
                    refreshUI();
                } else { appData = initialData; refreshUI(); }
            });
        }

        function saveData() {
            localStorage.setItem('nokshaData', JSON.stringify(appData));
            if (activeDB) { activeDB.collection('noksha_store').doc('main_data').set(appData).catch(err => console.error("Save Error", err)); }
            refreshUI();
        }

        function confirmResetProfit() {
            if(confirm("সতর্কতা: আপনি কি 'মোট লাভ' এর হিসাব ০ (শূন্য) করতে চান?")) {
                appData.profit = 0;
                saveData();
                renderAdminPanel();
                showToast("লাভের হিসাব রিসেট করা হয়েছে", "success");
            }
        }

        function resetCash() {
            if(confirm("সতর্কতা: আপনি কি নিশ্চিত ক্যাশ ব্যালেন্স ০ (শূন্য) করতে চান?")) {
                appData.cash = 0;
                addToHistory('ক্যাশ রিসেট', 'ম্যানুয়াল রিসেট', 0, 0, 0, 0);
                saveData();
                renderAdminPanel();
                closeModal('modal-manage-cash');
                showToast("ক্যাশ রিসেট করা হয়েছে", "success");
            }
        }

        function openHardResetModal() {
            document.getElementById('modal-hard-reset').classList.remove('hidden');
        }

        function submitHardReset() {
            if(!activeDB) { showToast("ডাটাবেজ কানেক্টেড নয়!", "error"); return; }
            
            const wipeHistory = document.getElementById('reset-history').checked;
            const wipeAccounts = document.getElementById('reset-accounts').checked;
            const wipeItems = document.getElementById('reset-items').checked;
            const wipeOrders = document.getElementById('reset-orders').checked;

            if(!wipeHistory && !wipeAccounts && !wipeItems && !wipeOrders) {
                showToast("কমপক্ষে একটি অপশন সিলেক্ট করুন", "error");
                return;
            }

            if(confirm("আপনি কি নিশ্চিত নির্বাচিত ডাটাগুলো ডিলিট করতে চান?")) {
                if (wipeHistory) appData.history = [];
                if (wipeAccounts) appData.accounts = [];
                if (wipeItems) appData.items = [];
                if (wipeOrders) appData.orders = [];

                saveData();
                closeModal('modal-hard-reset');
                showToast("নির্বাচিত ডাটা ডিলিট করা হয়েছে", "success");
                refreshUI();
            }
        }

        // --- UI REFRESH ---
        function refreshUI() {
            if(!document.getElementById('section-customer').classList.contains('hidden-section')) renderCustomerView();
            if(!document.getElementById('section-admin').classList.contains('hidden-section')) renderAdminPanel();
            if(!document.getElementById('section-orders').classList.contains('hidden-section')) renderOrders();
            if(!document.getElementById('modal-manage-accounts').classList.contains('hidden')) renderAccountsList();
        }

        function showSection(sectionName) {
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('nav-active'));
            document.getElementById(`nav-${sectionName === 'admin' ? 'admin' : (sectionName === 'orders' ? 'orders' : 'customer')}`).classList.add('nav-active');
            document.getElementById('section-customer').classList.add('hidden-section');
            document.getElementById('section-admin').classList.add('hidden-section');
            document.getElementById('section-orders').classList.add('hidden-section');
            document.getElementById(`section-${sectionName}`).classList.remove('hidden-section');
            if (sectionName === 'customer') renderCustomerView();
            if (sectionName === 'admin') renderAdminPanel();
            if (sectionName === 'orders') renderOrders();
        }

        function renderNav() {
            const orderBtn = document.getElementById('nav-orders');
            if (isAdminLoggedIn) { orderBtn.classList.remove('hidden'); } else { orderBtn.classList.add('hidden'); }
        }

        // --- RENDER FUNCTIONS ---
        function renderCustomerView() {
            const container = document.getElementById('customer-services-container');
            const searchVal = document.getElementById('customer-search').value.toLowerCase();
            container.innerHTML = '';
            
            if (!activeDB && !localStorage.getItem('activeConfig')) {
                 container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl mb-3 text-blue-500"></i><p>সিস্টেম কানেক্ট হচ্ছে, অপেক্ষা করুন...</p></div>`;
                 setTimeout(() => { if(!activeDB && container.innerHTML.includes('সিস্টেম কানেক্ট হচ্ছে')) { container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10"><i class="fa-solid fa-box-open text-4xl mb-3 opacity-50"></i><p>কোনো সার্ভিস ডাটা পাওয়া যায়নি।</p></div>`; } }, 5000);
                 return;
            }

            if (appData.items.length === 0) {
                 container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10"><i class="fa-solid fa-box-open text-4xl mb-3 opacity-50"></i><p>কোনো সার্ভিস যুক্ত করা নেই।</p></div>`;
                 return;
            }

            appData.items.forEach(item => {
                if (item.name.toLowerCase().includes(searchVal) || item.category.toLowerCase().includes(searchVal)) {
                    const card = `
                        <div class="bg-dark-800 rounded-xl overflow-hidden border border-gray-700 hover:border-blue-500 transition shadow-lg group">
                            <div class="p-5 cursor-pointer" onclick="openProductDetails(${item.id}, 'customer')">
                                <div class="flex justify-between items-start">
                                    <span class="bg-blue-900 text-blue-300 text-xs px-2 py-1 rounded uppercase font-bold">${item.category}</span>
                                    <span class="text-green-400 font-bold">৳ ${item.price}</span>
                                </div>
                                <h3 class="text-xl font-bold text-white mt-3">${item.name}</h3>
                                <div class="mt-4 bg-dark-900 p-3 rounded text-sm text-gray-400">
                                    <i class="fa-solid fa-file-lines mr-2"></i> বিস্তারিত জানতে ক্লিক করুন
                                </div>
                            </div>
                            <button onclick="openOrderModal(${item.id})" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 font-bold transition">অর্ডার করুন <i class="fa-solid fa-arrow-right ml-2"></i></button>
                        </div>`;
                    container.innerHTML += card;
                }
            });
        }

        function renderAdminPanel() {
            let totalAccountBalance = appData.accounts.reduce((acc, curr) => acc + parseInt(curr.balance), 0);
            appData.balance = totalAccountBalance;
            let totalStockVal = appData.items.reduce((acc, item) => { if(item.stock > 0) return acc + (item.cost * item.stock); return acc; }, 0);
            appData.stockVal = totalStockVal;
            
            // Calc Capital
            appData.capital = appData.cash + totalAccountBalance + totalStockVal;

            const statsContainer = document.getElementById('admin-stats-container');
            statsContainer.innerHTML = '';
            
            // --- FIX: Check for 'capital' in cardOrder ---
            if(!appData.cardOrder || !Array.isArray(appData.cardOrder)) {
                appData.cardOrder = ['capital', 'cash', 'balance', 'stock', 'profit'];
            } else if(!appData.cardOrder.includes('capital')) {
                appData.cardOrder.unshift('capital');
            }

            appData.cardOrder.forEach((key, index) => {
                const def = statsDefinitions[key];
                if(!def) return;
                const val = appData[def.valueKey];
                let cardClasses = "draggable-item bg-dark-800 p-5 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden group transition";
                let onClickAttr = "";
                if (def.action) { cardClasses += ` cursor-pointer hover:border-${def.color}-500`; onClickAttr = `onclick="${def.action}"`; }
                
                const card = `
                    <div ${onClickAttr} class="${cardClasses}" draggable="true" data-type="card" data-index="${index}">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <i class="fa-solid ${def.icon} text-6xl text-${def.color}-500"></i>
                        </div>
                        <h4 class="text-gray-400 text-sm font-medium uppercase flex items-center gap-2">
                            <i class="fa-solid fa-grip-vertical text-gray-600 cursor-grab mr-1"></i> ${def.title}
                            ${def.action ? `<i class="fa-solid fa-pen-to-square text-gray-500 text-xs hover:text-white ml-auto"></i>` : ''}
                        </h4>
                        <p class="text-2xl font-bold text-${def.color}-400 mt-1">৳ ${val}</p>
                        ${def.sub ? `<p class="text-[10px] text-gray-500 mt-1">${def.sub}</p>` : ''}
                    </div>
                `;
                statsContainer.innerHTML += card;
            });

            renderAdminItems();
            renderHistory();
            addDragListeners();
        }

        function renderAdminItems() {
            const tbody = document.getElementById('admin-items-body');
            const searchVal = document.getElementById('admin-search').value.toLowerCase();
            tbody.innerHTML = '';
            
            if (appData.items.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="7" class="p-5 text-center text-gray-500">কোনো আইটেম নেই।</td></tr>`;
                 return;
            }

            const isDraggable = searchVal === '';

            appData.items.forEach((item, index) => {
                if (item.name.toLowerCase().includes(searchVal) || item.category.toLowerCase().includes(searchVal)) {
                    const draggableAttr = isDraggable ? 'draggable="true"' : '';
                    const rowClass = isDraggable ? 'draggable-item' : '';
                    
                    const row = `
                        <tr class="border-b border-gray-700 hover:bg-dark-700 transition ${rowClass}" ${draggableAttr} data-type="item" data-index="${index}">
                            <td class="p-3 text-white font-medium flex items-center gap-2">
                                ${isDraggable ? '<i class="fa-solid fa-grip-lines text-gray-600 mr-2 cursor-grab"></i>' : ''}
                                <span class="hover:text-blue-400 cursor-pointer hover:underline" onclick="openProductDetails(${item.id}, 'admin')">${item.name}</span>
                            </td>
                            <td class="p-3"><span class="bg-gray-700 text-xs px-2 py-1 rounded">${item.category}</span></td>
                            <td class="p-3 text-red-300">${item.cost}</td>
                            <td class="p-3 text-green-300">${item.price}</td>
                            <td class="p-3">${item.stock === -1 ? '∞' : item.stock}</td>
                            <td class="p-3 text-center">
                                <button onclick="openQuickSaleModal(${item.id})" class="bg-green-600 hover:bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center mx-auto shadow-md transform hover:scale-110 transition"><i class="fa-solid fa-check"></i></button>
                            </td>
                            <td class="p-3 text-right">
                                <button onclick="openItemModal(${item.id})" class="text-blue-400 hover:text-blue-300 mr-2"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteItem(${item.id})" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                }
            });
            if (isDraggable) addDragListeners();
        }

        // --- GLOBAL DRAG AND DROP LOGIC ---
        let dragSrcEl = null; let dragType = null; let dragStartIndex = null;
        function addDragListeners() {
            const items = document.querySelectorAll('.draggable-item');
            items.forEach(item => {
                item.removeEventListener('dragstart', handleDragStart); item.removeEventListener('dragover', handleDragOver); item.removeEventListener('drop', handleDrop); item.removeEventListener('dragenter', handleDragEnter); item.removeEventListener('dragleave', handleDragLeave);
                item.addEventListener('dragstart', handleDragStart); item.addEventListener('dragover', handleDragOver); item.addEventListener('drop', handleDrop); item.addEventListener('dragenter', handleDragEnter); item.addEventListener('dragleave', handleDragLeave);
            });
        }
        function handleDragStart(e) { dragSrcEl = this; dragType = this.getAttribute('data-type'); dragStartIndex = +this.getAttribute('data-index'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
        function handleDragEnter(e) { this.classList.add('bg-dark-600'); }
        function handleDragLeave(e) { this.classList.remove('bg-dark-600'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation(); this.classList.remove('dragging'); this.classList.remove('bg-dark-600');
            const targetType = this.getAttribute('data-type'); const targetIndex = +this.getAttribute('data-index');
            if (dragSrcEl !== this && dragType === targetType) {
                if (dragType === 'item') { const movedItem = appData.items.splice(dragStartIndex, 1)[0]; appData.items.splice(targetIndex, 0, movedItem); saveData(); renderAdminItems(); } 
                else if (dragType === 'card') { const movedCard = appData.cardOrder.splice(dragStartIndex, 1)[0]; appData.cardOrder.splice(targetIndex, 0, movedCard); saveData(); renderAdminPanel(); }
                else if (dragType === 'account') { const movedAcc = appData.accounts.splice(dragStartIndex, 1)[0]; appData.accounts.splice(targetIndex, 0, movedAcc); saveData(); renderAccountsList(); }
                else if (dragType === 'db') { const movedDb = localDbList.splice(dragStartIndex, 1)[0]; localDbList.splice(targetIndex, 0, movedDb); const orderIds = localDbList.map(db => db.id); localStorage.setItem('dbListOrder', JSON.stringify(orderIds)); renderDbList(); showToast("ডাটাবেজ সাজানো হয়েছে", "success"); }
            } return false;
        }

        // --- NEW FEATURES LOGIC ---

        function openProductDetails(id, viewType) {
            const item = appData.items.find(i => i.id === id);
            if(!item) return;

            document.getElementById('pd-name').innerText = item.name;
            document.getElementById('pd-category').innerText = item.category;
            const contentDiv = document.getElementById('pd-content');
            contentDiv.innerHTML = '';

            if (viewType === 'admin') {
                const totalStockCost = item.stock * item.cost;
                const totalStockSale = item.stock * item.price;
                const totalStockProfit = item.stock * (item.price - item.cost);
                
                contentDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-dark-800 p-3 rounded">
                            <p class="text-gray-400">বর্তমান স্টক</p>
                            <p class="text-xl font-bold text-white">${item.stock} টি</p>
                        </div>
                        <div class="bg-dark-800 p-3 rounded">
                            <p class="text-gray-400">প্রতি পিস লাভ</p>
                            <p class="text-xl font-bold text-green-400">৳ ${item.price - item.cost}</p>
                        </div>
                    </div>
                    <div class="bg-dark-900 p-4 rounded border border-gray-700">
                        <h4 class="text-gray-300 font-bold mb-3 border-b border-gray-700 pb-2">স্টক বিশ্লেষণ</h4>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-400">মোট কেনা খরচ:</span>
                            <span class="text-red-400 font-bold">৳ ${totalStockCost}</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-400">সম্ভাব্য বিক্রয় মূল্য:</span>
                            <span class="text-blue-400 font-bold">৳ ${totalStockSale}</span>
                        </div>
                        <div class="flex justify-between pt-2 border-t border-gray-700">
                            <span class="text-gray-300">সম্ভাব্য মোট লাভ:</span>
                            <span class="text-green-400 font-bold text-lg">৳ ${totalStockProfit}</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-xs text-gray-500 mb-1">প্রয়োজনীয় কাগজপত্র:</p>
                        <p class="text-gray-300 text-sm bg-dark-800 p-2 rounded">${item.docs}</p>
                    </div>
                `;
            } else {
                // Customer View
                const docsList = item.docs.split(',').map(d => d.trim()).filter(d => d).map(d => `<li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i><span>${d}</span></li>`).join('');
                
                contentDiv.innerHTML = `
                    <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/30 mb-4">
                        <p class="text-center text-blue-300 font-bold text-lg">মূল্য: ৳ ${item.price}</p>
                    </div>
                    <div>
                        <h4 class="text-white font-bold mb-3"><i class="fa-solid fa-file-lines mr-2"></i>প্রয়োজনীয় কাগজপত্র:</h4>
                        <ul class="space-y-2 text-gray-300 text-sm">
                            ${docsList.length ? docsList : '<li class="text-gray-500 italic">কোনো বিশেষ কাগজপত্রের প্রয়োজন নেই।</li>'}
                        </ul>
                    </div>
                    <div class="mt-6 text-center text-xs text-gray-500">
                        * বিস্তারিত জানতে বা অর্ডার করতে নিচের "অর্ডার করুন" বাটনে ক্লিক করুন।
                    </div>
                `;
            }

            document.getElementById('modal-product-details').classList.remove('hidden');
        }

        let currentQuickSaleItem = null;
        function openQuickSaleModal(id) {
            currentQuickSaleItem = appData.items.find(i => i.id === id);
            document.getElementById('qs-name').innerText = currentQuickSaleItem.name;
            document.getElementById('qs-price').innerText = currentQuickSaleItem.price;
            document.getElementById('qs-cost').innerText = currentQuickSaleItem.cost;
            
            document.getElementById('qs-qty').value = 1;
            document.getElementById('qs-custom-price').value = currentQuickSaleItem.price; // Set default price
            
            updateQSPreview();
            document.getElementById('modal-quicksale').classList.remove('hidden');
        }

        function updateQSPreview() {
            if(!currentQuickSaleItem) return;
            const qty = parseInt(document.getElementById('qs-qty').value) || 0;
            const customPrice = parseInt(document.getElementById('qs-custom-price').value) || 0;
            
            const totalBill = qty * customPrice;
            const totalCost = qty * currentQuickSaleItem.cost;
            const potentialProfit = totalBill - totalCost;

            document.getElementById('qs-total').innerText = totalBill;
            
            const profitEl = document.getElementById('qs-profit-preview');
            profitEl.innerText = potentialProfit;
            profitEl.className = potentialProfit >= 0 ? "text-green-400" : "text-red-400";
        }

        function submitQuickSale() {
            const qty = parseInt(document.getElementById('qs-qty').value) || 1;
            const customPrice = parseInt(document.getElementById('qs-custom-price').value) || 0;
            
            if (qty < 1) return;
            const item = currentQuickSaleItem;
            
            const totalCost = parseInt(item.cost) * qty;
            const totalPrice = customPrice * qty; // Use Custom Price
            const totalProfit = totalPrice - totalCost;
            
            appData.cash += totalPrice;
            appData.profit += totalProfit;
            if (item.stock > 0) item.stock = Math.max(0, item.stock - qty);

            // Updated History Message to show custom price if changed
            let note = item.name;
            if(customPrice !== item.price) note += ` (Sold @ ${customPrice})`;

            addToHistory('বিক্রয়', note, qty, totalCost, totalPrice, totalProfit);
            saveData();
            closeModal('modal-quicksale');
            showToast("বিক্রয় সফল", "success");
        }

        // --- EXISTING HELPER FUNCTIONS ---
        function openOrderModal(id) { const item = appData.items.find(i => i.id === id); if (!item) return; document.getElementById('order-item-name').innerText = item.name; document.getElementById('order-item-price').innerText = item.price; document.getElementById('modal-order').classList.remove('hidden'); }
        function submitOrder() { 
            const name = document.getElementById('order-customer-name').value;
            const phone = document.getElementById('order-customer-phone').value;
            const itemName = document.getElementById('order-item-name').innerText;
            const item = appData.items.find(i => i.name === itemName);
            
            if(!name || !phone) { showToast("তথ্য দিন!", "error"); return; }
            
            // Ensure orders array exists
            if (!appData.orders) appData.orders = [];

            appData.orders.unshift({
                id: Date.now().toString().slice(-4),
                itemName: itemName,
                cost: item ? item.cost : 0,
                price: item ? item.price : 0,
                customerName: name,
                customerPhone: phone,
                date: new Date().toLocaleString('bn-BD')
            });
            saveData();
            
            // Force Update UI if admin is logged in (to reflect order count/list immediately)
            if(isAdminLoggedIn) renderOrders();

            closeModal('modal-order'); 
            showToast("অর্ডার সফলভাবে সম্পন্ন হয়েছে", "success"); 
        }
        function approveOrder(index) { const order = appData.orders[index]; const qty = 1; const totalCost = parseInt(order.cost) * qty; const totalPrice = parseInt(order.price) * qty; const totalProfit = totalPrice - totalCost; appData.cash += totalPrice; appData.profit += totalProfit; addToHistory('অর্ডার সম্পন্ন', order.itemName, qty, totalCost, totalPrice, totalProfit); appData.orders.splice(index, 1); saveData(); renderOrders(); renderAdminPanel(); showToast("অর্ডার এপ্রুভ হয়েছে", "success"); }
        function deleteOrder(index) { if(confirm("অর্ডারটি বাতিল করতে চান?")) { appData.orders.splice(index, 1); saveData(); renderOrders(); } }
        function addToHistory(type, name, qty, cost, price, profit) { appData.history.unshift({ id: Date.now(), type, name, qty, totalCost: cost, totalPrice: price, totalProfit: profit, dateStr: new Date().toLocaleDateString('bn-BD'), timeStr: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }) }); if (appData.history.length > 200) appData.history.pop(); }
        function renderHistory() { const tbody = document.getElementById('history-body'); tbody.innerHTML = ''; if (appData.history.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">কোনো হিস্ট্রি নেই।</td></tr>'; return; } appData.history.forEach(h => { let typeClass = h.type.includes('বিক্রয়') ? 'text-blue-400' : (h.type.includes('জমা') ? 'text-green-400' : 'text-purple-400'); if(h.type.includes('উত্তোলন') || h.type.includes('খরচ')) typeClass = 'text-red-400'; const row = `<tr class="border-b border-gray-800 hover:bg-dark-800 transition"><td class="p-3 text-gray-400 text-xs font-bold">${h.dateStr}<br><span class="opacity-70 font-normal">${h.timeStr}</span></td><td class="p-3"><div class="font-medium text-white text-sm">${h.name}</div><div class="text-[10px] ${typeClass}">${h.type}</div></td><td class="p-3 text-center"><span class="bg-dark-700 text-gray-300 px-2 py-1 rounded text-xs font-bold">${h.qty || 1}</span></td><td class="p-3 text-right text-gray-400 text-xs">৳ ${h.totalCost || 0}</td><td class="p-3 text-right text-white font-bold text-sm">৳ ${h.totalPrice || 0}</td><td class="p-3 text-right text-green-400 font-bold text-sm">+ ৳ ${h.totalProfit || 0}</td></tr>`; tbody.innerHTML += row; }); }
        function resetHistory() { if(confirm("সব হিস্ট্রি মুছবেন?")) { appData.history = []; saveData(); } }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg, type) { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed top-20 right-5 z-50 p-4 rounded-lg shadow-xl text-white ${type==='success'?'bg-green-600':(type==='error'?'bg-red-600':'bg-gray-600')}`; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
        function openAccountsModal() { renderAccountsList(); document.getElementById('modal-manage-accounts').classList.remove('hidden'); }
        function renderAccountsList() { const tbody = document.getElementById('accounts-list-body'); tbody.innerHTML = ''; let total = 0; if(appData.accounts.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-5 text-center text-gray-500">কোনো অ্যাকাউন্ট নেই। নতুন যুক্ত করুন।</td></tr>'; } appData.accounts.forEach((acc, index) => { total += parseInt(acc.balance); tbody.innerHTML += `<tr class="draggable-item border-b border-gray-700 hover:bg-dark-800 transition" draggable="true" data-type="account" data-index="${index}"><td class="p-3 text-white font-medium flex items-center gap-2"><i class="fa-solid fa-grip-lines text-gray-600 cursor-grab mr-2"></i> ${acc.name}</td><td class="p-3 text-right text-blue-400 font-bold">৳ ${acc.balance}</td><td class="p-3 text-center"><button onclick="openAccountTransactModal(${acc.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs"><i class="fa-solid fa-money-bill-transfer"></i></button></td><td class="p-3 text-right"><button onclick="editAccount(${acc.id})" class="text-blue-400 hover:text-white mr-2 text-xs"><i class="fa-solid fa-pen"></i></button><button onclick="deleteAccount(${acc.id})" class="text-red-400 hover:text-white text-xs"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); document.getElementById('modal-total-balance').innerText = '৳ ' + total; addDragListeners(); }
        function openAccountFormModal(id = null) { document.getElementById('modal-account-form').classList.remove('hidden'); const balanceLabel = document.querySelector('#initial-balance-div label'); if(id) { const acc = appData.accounts.find(a => a.id === id); document.getElementById('account-form-title').innerText = "অ্যাকাউন্ট এডিট করুন"; document.getElementById('account-id').value = acc.id; document.getElementById('account-name').value = acc.name; document.getElementById('initial-balance-div').classList.remove('hidden'); document.getElementById('account-initial-balance').value = acc.balance; balanceLabel.innerText = "বর্তমান ব্যালেন্স (সংশোধন)"; } else { document.getElementById('account-form-title').innerText = "নতুন অ্যাকাউন্ট"; document.getElementById('account-id').value = ''; document.getElementById('account-name').value = ''; document.getElementById('account-initial-balance').value = ''; document.getElementById('initial-balance-div').classList.remove('hidden'); balanceLabel.innerText = "শুরুর ব্যালেন্স"; } }
        function saveAccount() { const id = document.getElementById('account-id').value; const name = document.getElementById('account-name').value; const balanceVal = parseInt(document.getElementById('account-initial-balance').value) || 0; if(!name) return; if(id) { const index = appData.accounts.findIndex(a => a.id == id); appData.accounts[index].name = name; appData.accounts[index].balance = balanceVal; } else { appData.accounts.push({ id: Date.now(), name: name, balance: balanceVal }); if(balanceVal > 0) addToHistory('নতুন অ্যাকাউন্ট', `${name} যুক্ত হয়েছে`, 1, 0, balanceVal, 0); } saveData(); closeModal('modal-account-form'); }
        function deleteAccount(id) { if(confirm("ডিলিট করবেন?")) { appData.accounts = appData.accounts.filter(a => a.id !== id); saveData(); renderAccountsList(); } }
        function editAccount(id) { openAccountFormModal(id); }
        function openAccountTransactModal(id) { const acc = appData.accounts.find(a => a.id === id); document.getElementById('transact-account-id').value = acc.id; document.getElementById('transact-account-name').innerText = acc.name + " - লেনদেন"; document.getElementById('modal-account-transact').classList.remove('hidden'); }
        
        // FIXED: Account Transaction Logic
        function submitAccountTransaction(type) { 
            const id = parseInt(document.getElementById('transact-account-id').value); 
            const amount = parseInt(document.getElementById('transact-amount').value); 
            const desc = document.getElementById('transact-desc').value || (type === 'deposit' ? 'জমা' : 'খরচ'); 
            
            if(!amount) return; 
            const acc = appData.accounts.find(a => a.id === id); 
            
            if(type === 'deposit') { 
                acc.balance += amount; 
                addToHistory('অ্যাকাউন্ট জমা', `${acc.name} - ${desc}`, 1, 0, amount, 0); 
            } else { 
                if(acc.balance < amount) { showToast("ব্যালেন্স কম!", "error"); return; } 
                
                // Deduct from Account
                acc.balance -= amount; 
                
                // Add to Cash (Transfer logic: Account -> Cash)
                appData.cash += amount;

                addToHistory('অ্যাকাউন্ট থেকে ক্যাশ', `${acc.name} - ${desc}`, 1, amount, 0, 0); 
            } 
            saveData(); 
            closeModal('modal-account-transact'); 
            renderAdminPanel(); // To show updated Cash
        }
        
        function openManageCashModal() { document.getElementById('modal-manage-cash').classList.remove('hidden'); }
        function submitCashTransaction(type) { const amount = parseInt(document.getElementById('manage-cash-amount').value); const desc = document.getElementById('manage-cash-desc').value || (type === 'add' ? 'জমা' : 'উত্তোলন'); if(!amount) return; if (type === 'add') { appData.cash += amount; addToHistory('ম্যানুয়াল ক্যাশ জমা', desc, 1, 0, amount, 0); } else { if (appData.cash < amount) { showToast("ক্যাশ নেই!", "error"); return; } appData.cash -= amount; addToHistory('ক্যাশ উত্তোলন', desc, 1, 0, amount, 0); } saveData(); closeModal('modal-manage-cash'); }
        function openItemModal(id = null) { document.getElementById('modal-item').classList.remove('hidden'); if(id) { const item = appData.items.find(i => i.id === id); document.getElementById('modal-item-title').innerText = "এডিট করুন"; document.getElementById('item-id').value = item.id; document.getElementById('item-name').value = item.name; document.getElementById('item-category').value = item.category; document.getElementById('item-docs').value = item.docs; document.getElementById('item-cost').value = item.cost; document.getElementById('item-price').value = item.price; document.getElementById('item-stock').value = item.stock; } else { document.getElementById('modal-item-title').innerText = "নতুন প্রোডাক্ট"; document.getElementById('item-id').value = ''; document.getElementById('item-name').value = ''; document.getElementById('item-category').value = ''; document.getElementById('item-docs').value = ''; document.getElementById('item-cost').value = ''; document.getElementById('item-price').value = ''; document.getElementById('item-stock').value = ''; } }
        function saveItem() { const id = document.getElementById('item-id').value; const newItem = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('item-name').value, category: document.getElementById('item-category').value, docs: document.getElementById('item-docs').value, cost: parseInt(document.getElementById('item-cost').value), price: parseInt(document.getElementById('item-price').value), stock: parseInt(document.getElementById('item-stock').value) }; if (id) { const index = appData.items.findIndex(i => i.id == id); appData.items[index] = newItem; } else { appData.items.push(newItem); } saveData(); closeModal('modal-item'); }
        function deleteItem(id) { if(confirm("ডিলিট করবেন?")) { appData.items = appData.items.filter(i => i.id !== id); saveData(); renderAdminItems(); } }

        window.onload = function() {
            if(localStorage.getItem('nokshaData')) { appData = JSON.parse(localStorage.getItem('nokshaData')); }
            initMasterApp(MASTER_CONFIG);
            if(savedActiveConfig) { initActiveApp(JSON.parse(savedActiveConfig)); }
            renderNav(); refreshUI();
        };
    </script>
</body>
</html>